

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Basalt - Visual Inertial Odometry &mdash; Dense Reconstruction Toolkit  documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="MonoRec - Dense Reconstruction" href="monorec.html" />
    <link rel="prev" title="Extras" href="../documentation/extras/index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Dense Reconstruction Toolkit
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Tutorials:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/quickstart.html">Quick Start</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Documentation:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../documentation/euroc-preparation/index.html">Euroc Preparation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../documentation/trajectory_visualization/index.html">Trajectory Visualization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../documentation/extras/index.html">Extras</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Third-Party Tools:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Basalt - Visual Inertial Odometry</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#installation-from-source">Installation (from source)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#changes-to-the-original-package">Changes to the original package</a></li>
<li class="toctree-l2"><a class="reference internal" href="#changed-files">Changed files</a></li>
<li class="toctree-l2"><a class="reference internal" href="#running-vio">Running VIO</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="monorec.html">MonoRec - Dense Reconstruction</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Community:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../developers.html">Main developers</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Dense Reconstruction Toolkit</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Basalt - Visual Inertial Odometry</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/hardik01shah/DenseReconstructionTools/blob/master/docs/third-party-tools/basalt.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="basalt-visual-inertial-odometry">
<h1>Basalt - Visual Inertial Odometry<a class="headerlink" href="#basalt-visual-inertial-odometry" title="Link to this heading"></a></h1>
<p>This is a <a class="reference external" href="https://github.com/RobotVisionHKA/basalt">fork</a> of the <a class="reference external" href="https://gitlab.com/VladyslavUsenko/basalt">Basalt</a> repository with
changes made on top so that it can be used as a VIO system for the dense MVS reconstruction network <a class="reference external" href="https://github.com/RobotVisionHKA/MonoRec">MonoRec</a>.</p>
<section id="installation-from-source">
<h2>Installation (from source)<a class="headerlink" href="#installation-from-source" title="Link to this heading"></a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git<span class="w"> </span>clone<span class="w"> </span>--recursive<span class="w"> </span>https://github.com/RobotVisionHKA/basalt.git
<span class="nb">cd</span><span class="w"> </span>basalt
./scripts/install_deps.sh
mkdir<span class="w"> </span>build
<span class="nb">cd</span><span class="w"> </span>build
cmake<span class="w"> </span>..<span class="w"> </span>-DCMAKE_BUILD_TYPE<span class="o">=</span>RelWithDebInfo
make<span class="w"> </span>-j8
</pre></div>
</div>
</section>
<section id="changes-to-the-original-package">
<h2>Changes to the original package<a class="headerlink" href="#changes-to-the-original-package" title="Link to this heading"></a></h2>
<p>The primary target in order to make Basalt compatible with MonoRec was to extract
the keyframe poses (for both training and inference) and also the tracked keypoints in the keyframes
(for the sparse depth supervised loss in MonoRec, only for training).
Here are the changes that were made on top of the existing Basalt code:</p>
<ol class="arabic">
<li><p>A <code class="docutils literal notranslate"><span class="pre">keyframe_data_path</span></code> flag is added, which when valid saves the poses and keypoints in the following directory structure:</p>
<blockquote>
<div><div class="highlight-text notranslate"><div class="highlight"><pre><span></span>keyframe_data_path
    ├── keypoints
    |   ├── ts1.txt
    |   ├── ts2.txt
    |   └── ..
    ├── keypoints_viz
    |   ├── ts1.txt
    |   ├── ts2.txt
    |   └── ..
    └── poses
        ├── keyframe_trajectory_cam.txt
        └── keyframe_trajectory_imu.txt
</pre></div>
</div>
<ul>
<li><p><em>keypoints_viz</em> contains the keypoints saved from the visualization queue.</p></li>
<li><p><em>keypoints</em> contains the keypoints saved from the marginal data queue. (keypoints are dropped from the optimization window, hence the images in the visualization queue contain more points)</p></li>
<li><p><em>poses</em> contains two text files, <em>keyframe_trajectory_cam.txt</em> which contains poses in the camera frame and <em>keyframe_trajectory_imu.txt</em> which contains poses in imu frame.</p>
<blockquote>
<div><div class="admonition note">
<p class="admonition-title">Note</p>
<ul class="simple">
<li><p>pose format is <code class="docutils literal notranslate"><span class="pre">ts(ns)</span> <span class="pre">px</span> <span class="pre">py</span> <span class="pre">pz</span> <span class="pre">qx</span> <span class="pre">qy</span> <span class="pre">qz</span> <span class="pre">qw</span></code></p></li>
<li><p>keypoints are stored in a separate text file for each timestamp. The first line contains the no. of keypoints tracked in the frame and subsequently each line contains <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">y</span> <span class="pre">inv_depth</span></code>.</p></li>
</ul>
</div>
</div></blockquote>
</li>
</ul>
</div></blockquote>
</li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">MargDataSaver</span></code> has been changed to take additional arguments
<code class="docutils literal notranslate"><span class="pre">[const</span> <span class="pre">string&amp;</span> <span class="pre">keyframe_data_path,</span> <span class="pre">const</span> <span class="pre">basalt::Calibration&lt;double&gt;</span> <span class="pre">calib]</span></code>.
The calibration matrix is required to convert the poses from the imu frame to the camera frame.</p>
<blockquote>
<div><div class="admonition note">
<p class="admonition-title">Note</p>
<p>poses in the margdata queue are in the imu frame</p>
</div>
</div></blockquote>
</li>
<li><p>MargData Saver saves keypoints and poses for each timestamp in the MargDataQueue if the <code class="docutils literal notranslate"><span class="pre">keyframe_data_path</span></code>
is valid. There are 7 poses for each window and the one that matches the timestamp is saved.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">MargDataPtr</span></code> data structure was changed to save the keypoints as a vector.
Whenever data is pushed into the margdata queue, keypoints are computed for the window using optical flow,
the <code class="docutils literal notranslate"><span class="pre">computeProjections</span></code> function. The computed keypoints are then added to the <code class="docutils literal notranslate"><span class="pre">MargDataPtr</span></code>.</p></li>
<li><p>For saving keypoints from the visualization queue, whenever data is pushed into the viz_queue, keypoints
are directly saved if the ‘keyframe_data_path’ is valid. Done in
the <a class="reference external" href="https://github.com/RobotVisionHKA/basalt/blob/master/src/vi_estimator/sqrt_keypoint_vio.cpp">sqrt_keypoint_vio.cpp</a> file.</p></li>
</ol>
</section>
<section id="changed-files">
<h2>Changed files<a class="headerlink" href="#changed-files" title="Link to this heading"></a></h2>
<ol class="arabic simple">
<li><dl class="simple">
<dt><a class="reference external" href="https://github.com/RobotVisionHKA/basalt/blob/master/src/vio.cpp">vio.cpp</a></dt><dd><ul class="simple">
<li><p>add flag for saving keyframe_data</p></li>
<li><p>change call to <code class="docutils literal notranslate"><span class="pre">MargDataSaver</span></code>. add arguments - <code class="docutils literal notranslate"><span class="pre">keyframe_data_path</span></code> and calib data</p></li>
<li><p>change call to initialize vio estimator. add argument - <code class="docutils literal notranslate"><span class="pre">keyframe_data_path</span></code></p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><a class="reference external" href="https://github.com/RobotVisionHKA/basalt/blob/master/src/vio_sim.cpp">vio_sim.cpp</a></dt><dd><ul class="simple">
<li><p>change call to <code class="docutils literal notranslate"><span class="pre">MargDataSaver</span></code>. add arguments - <code class="docutils literal notranslate"><span class="pre">keyframe_data_path</span></code> and calib data</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><a class="reference external" href="https://github.com/RobotVisionHKA/basalt/blob/master/src/io/marg_data_io.cpp">marg_data_io.cpp</a> and <a class="reference external" href="https://github.com/RobotVisionHKA/basalt/blob/master/include/basalt/io/marg_data_io.h">marg_data_io.h</a></dt><dd><ul class="simple">
<li><p>save poses from the margdata queue</p></li>
<li><p>save keypoints in cam frame (if ‘<code class="docutils literal notranslate"><span class="pre">keyframe_data_path</span></code>’ is valid)</p></li>
<li><p>save keypoints in imu frame (if ‘<code class="docutils literal notranslate"><span class="pre">keyframe_data_path</span></code>’ is valid)</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><a class="reference external" href="https://github.com/RobotVisionHKA/basalt/blob/master/src/vi_estimator/sqrt_keypoint_vio.cpp">sqrt_keypoint_vio.cpp</a> and <a class="reference external" href="https://github.com/RobotVisionHKA/basalt/blob/master/include/basalt/vi_estimator/sqrt_keypoint_vio.h">sqrt_keypoint_vio.h</a></dt><dd><ul class="simple">
<li><p>compute and add keypoint information when data is being pushed into the margdata queue</p></li>
<li><p>save keypoints directly before pushing into the viz_queue (if ‘<code class="docutils literal notranslate"><span class="pre">keyframe_data_path</span></code>’ is valid)</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><a class="reference external" href="https://github.com/RobotVisionHKA/basalt/blob/master/src/vi_estimator/sqrt_keypoint_vo.cpp">sqrt_keypoint_vo.cpp</a>, <a class="reference external" href="https://github.com/RobotVisionHKA/basalt/blob/master/include/basalt/vi_estimator/sqrt_keypoint_vo.h">sqrt_keypoint_vo.h</a> and <a class="reference external" href="https://github.com/RobotVisionHKA/basalt/blob/master/include/basalt/vi_estimator/vio_estimator.h">vio_estimator.h</a></dt><dd><ul class="simple">
<li><p>change function definitions. add argument - <code class="docutils literal notranslate"><span class="pre">keyframe_data_path</span></code></p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><a class="reference external" href="https://github.com/RobotVisionHKA/basalt/blob/master/include/basalt/utils/imu_types.h">imu_types.h</a></dt><dd><ul class="simple">
<li><p>change data structure of <code class="docutils literal notranslate"><span class="pre">MargDataPtr</span></code> for saving keypoints</p></li>
</ul>
</dd>
</dl>
</li>
</ol>
</section>
<section id="running-vio">
<h2>Running VIO<a class="headerlink" href="#running-vio" title="Link to this heading"></a></h2>
<p>Create a new folder <em>run</em> in the parent directory and run VIO from this folder to
save all the stats there, but not compulsory. However, the command below assumes that VIO
is being executed from the <em>basalt/run</em> folder.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mkdir<span class="w"> </span>run
<span class="nb">cd</span><span class="w"> </span>run
</pre></div>
</div>
<p>Running VIO:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>App<span class="w"> </span>description
Usage:<span class="w"> </span>../build/basalt_vio<span class="w"> </span><span class="o">[</span>OPTIONS<span class="o">]</span>

Options:
<span class="w">  </span>-h,--help<span class="w">                   </span>Print<span class="w"> </span>this<span class="w"> </span><span class="nb">help</span><span class="w"> </span>message<span class="w"> </span>and<span class="w"> </span><span class="nb">exit</span>
<span class="w">  </span>--show-gui<span class="w"> </span>BOOLEAN<span class="w">          </span>Show<span class="w"> </span>GUI
<span class="w">  </span>--cam-calib<span class="w"> </span>TEXT<span class="w"> </span>REQUIRED<span class="w">   </span>Ground-truth<span class="w"> </span>camera<span class="w"> </span>calibration<span class="w"> </span>used<span class="w"> </span><span class="k">for</span><span class="w"> </span>simulation.
<span class="w">  </span>--dataset-path<span class="w"> </span>TEXT<span class="w"> </span>REQUIRED
<span class="w">                              </span>Path<span class="w"> </span>to<span class="w"> </span>dataset.
<span class="w">  </span>--dataset-type<span class="w"> </span>TEXT<span class="w"> </span>REQUIRED
<span class="w">                              </span>Dataset<span class="w"> </span><span class="nb">type</span><span class="w"> </span>&lt;euroc,<span class="w"> </span>bag&gt;.
<span class="w">  </span>--marg-data<span class="w"> </span>TEXT<span class="w">            </span>Path<span class="w"> </span>to<span class="w"> </span>folder<span class="w"> </span>where<span class="w"> </span>marginalization<span class="w"> </span>data<span class="w"> </span>will<span class="w"> </span>be<span class="w"> </span>stored.
<span class="w">  </span>--print-queue<span class="w"> </span>BOOLEAN<span class="w">       </span>Print<span class="w"> </span>queue.
<span class="w">  </span>--config-path<span class="w"> </span>TEXT<span class="w">          </span>Path<span class="w"> </span>to<span class="w"> </span>config<span class="w"> </span>file.
<span class="w">  </span>--result-path<span class="w"> </span>TEXT<span class="w">          </span>Path<span class="w"> </span>to<span class="w"> </span>result<span class="w"> </span>file<span class="w"> </span>where<span class="w"> </span>the<span class="w"> </span>system<span class="w"> </span>will<span class="w"> </span>write<span class="w"> </span>RMSE<span class="w"> </span>ATE.
<span class="w">  </span>--num-threads<span class="w"> </span>INT<span class="w">           </span>Number<span class="w"> </span>of<span class="w"> </span>threads.
<span class="w">  </span>--step-by-step<span class="w"> </span>BOOLEAN<span class="w">      </span>Path<span class="w"> </span>to<span class="w"> </span>config<span class="w"> </span>file.
<span class="w">  </span>--save-trajectory<span class="w"> </span>TEXT<span class="w">      </span>Save<span class="w"> </span>trajectory.<span class="w"> </span>Supported<span class="w"> </span>formats<span class="w"> </span>&lt;tum,<span class="w"> </span>euroc,<span class="w"> </span>kitti&gt;
<span class="w">  </span>--save-groundtruth<span class="w"> </span>BOOLEAN<span class="w">  </span>In<span class="w"> </span>addition<span class="w"> </span>to<span class="w"> </span>trajectory,<span class="w"> </span>save<span class="w"> </span>also<span class="w"> </span>ground<span class="w"> </span>truth
<span class="w">  </span>--use-imu<span class="w"> </span>BOOLEAN<span class="w">           </span>Use<span class="w"> </span>IMU.
<span class="w">  </span>--keyframe-data<span class="w"> </span>TEXT<span class="w">        </span>Path<span class="w"> </span><span class="k">for</span><span class="w"> </span>saving<span class="w"> </span>keyframe<span class="w"> </span>poses<span class="w"> </span>and<span class="w"> </span>keypoints.
<span class="w">  </span>--use-double<span class="w"> </span>BOOLEAN<span class="w">        </span>Use<span class="w"> </span>double<span class="w"> </span>not<span class="w"> </span>float.
<span class="w">  </span>--max-frames<span class="w"> </span>UINT<span class="w">           </span>Limit<span class="w"> </span>number<span class="w"> </span>of<span class="w"> </span>frames<span class="w"> </span>to<span class="w"> </span>process<span class="w"> </span>from<span class="w"> </span>dataset<span class="w"> </span><span class="o">(</span><span class="m">0</span><span class="w"> </span>means<span class="w"> </span>unlimited<span class="o">)</span>
</pre></div>
</div>
<p>E.g.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>../build/basalt_vio<span class="w"> </span>--dataset-path<span class="w"> </span>../../tumvi_data/test<span class="w"> </span>--cam-calib<span class="w"> </span>../../DenseReconstruction/basalt/data/test_1024_cropped.json<span class="w"> </span>--dataset-type<span class="w"> </span>euroc<span class="w"> </span>--config-path<span class="w"> </span>../../DenseReconstruction/basalt/data/tumvi_512_config.json<span class="w"> </span>--marg-data<span class="w"> </span>../../tumvi_data/test/temp_keyframe_data<span class="w"> </span>--show-gui<span class="w"> </span><span class="m">1</span><span class="w"> </span>--keyframe-data<span class="w"> </span>../../tumvi_data/test/kf_data<span class="w"> </span>--use-imu<span class="w"> </span><span class="m">1</span>
</pre></div>
</div>
<p><strong>_the keyframe_data_path must point to the *basalt_keyframe_data* folder within the parent directory of the dataset sequence for MonoRec to be compatible i.e. able to read the poses and keypoints. That is how the dataloader is implemented.</strong></p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../documentation/extras/index.html" class="btn btn-neutral float-left" title="Extras" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="monorec.html" class="btn btn-neutral float-right" title="MonoRec - Dense Reconstruction" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Robot Vision Lab, HKA. Author(s): Hardik Shah, Niclas Zeller.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>